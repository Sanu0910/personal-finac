<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: white;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            justify-content: center;
            align-items: center;
        }
        .modal.flex { display: flex; }
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

    <!-- Modals -->
    <div id="salary-modal" class="modal">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h2 class="text-2xl font-bold text-white mb-4">Set Your Monthly Salary</h2>
            <div class="relative"><i class="fa-solid fa-indian-rupee-sign absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i><input type="number" id="new-salary-input" placeholder="e.g., 50000" class="w-full bg-gray-900 text-white border-2 border-gray-700 rounded-lg py-3 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
            <div class="flex justify-end gap-4 mt-8"><button id="cancel-salary" class="py-2 px-6 bg-gray-600 hover:bg-gray-500 rounded-lg">Cancel</button><button id="save-salary" class="py-2 px-6 bg-blue-600 hover:bg-blue-500 rounded-lg">Save</button></div>
        </div>
    </div>
    <div id="bill-modal" class="modal">
        <form id="bill-form" class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <h2 class="text-2xl font-bold text-white mb-6">Add Credit Card Bill</h2>
            <div class="space-y-4">
                <input type="text" id="bill-card-name" placeholder="Card Name (e.g., HDFC Millennia)" required class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg py-3 px-4 focus:outline-none">
                <input type="number" id="bill-amount" placeholder="Amount" required class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg py-3 px-4 focus:outline-none">
                <input type="date" id="bill-due-date" required class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg py-3 px-4 focus:outline-none">
            </div>
            <div class="flex justify-end gap-4 mt-8"><button type="button" id="cancel-bill" class="py-2 px-6 bg-gray-600 rounded-lg">Cancel</button><button type="submit" class="py-2 px-6 bg-blue-600 rounded-lg">Add Bill</button></div>
        </form>
    </div>

    <!-- Loading Indicator -->
    <div id="loader" class="fixed inset-0 bg-gray-900 flex flex-col justify-center items-center z-50">
        <i class="fa-solid fa-piggy-bank text-5xl text-pink-500 animate-bounce"></i>
        <p class="mt-4 text-xl font-semibold">Loading Financials...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="hidden">
        <header class="mb-8 flex justify-between items-center">
            <div><h1 class="text-3xl sm:text-4xl font-bold">Expense Dashboard</h1><p class="text-gray-400 mt-1">Your complete financial overview.</p></div>
            <div id="user-id-display" class="text-xs font-mono bg-gray-800 text-gray-400 px-3 py-1 rounded-md"></div>
        </header>

        <div id="month-navigator" class="flex items-center justify-center gap-4 bg-gray-800 p-3 rounded-xl mb-8 shadow-md">
            <button id="prev-month" class="p-2 rounded-full hover:bg-gray-700"><i class="fa-solid fa-chevron-left"></i></button>
            <span id="month-year-display" class="font-bold text-xl w-48 text-center"></span>
            <button id="next-month" class="p-2 rounded-full hover:bg-gray-700"><i class="fa-solid fa-chevron-right"></i></button>
        </div>

        <section id="credit-card-hub" class="bg-gray-800 p-6 rounded-2xl shadow-lg mb-8">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold flex items-center gap-2"><i class="fa-solid fa-credit-card"></i> Credit Card Hub</h2><button id="add-bill-btn" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-semibold hover:bg-blue-500 flex items-center gap-1"><i class="fa-solid fa-plus"></i> Add Bill</button></div>
            <div id="pending-bills-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </section>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Stats & Charts -->
            <div class="lg:col-span-2 flex flex-col gap-8">
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Stat Cards -->
                    <div id="salary-card" class="p-4 md:p-6 rounded-2xl shadow-lg bg-gradient-to-br from-green-600 to-green-800"></div>
                    <div id="expenses-card" class="p-4 md:p-6 rounded-2xl shadow-lg bg-gradient-to-br from-red-600 to-red-800"></div>
                    <div id="dues-card" class="p-4 md:p-6 rounded-2xl shadow-lg bg-gradient-to-br from-yellow-600 to-yellow-800"></div>
                    <div id="balance-card" class="p-4 md:p-6 rounded-2xl shadow-lg bg-gradient-to-br from-blue-600 to-blue-800"></div>
                </div>
                
                <div id="financial-wisdom-card" class="bg-gradient-to-br from-gray-700 to-gray-800 p-6 rounded-2xl shadow-lg border border-gray-600"></div>
                
                <div id="budget-chart-container" class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2"><i class="fa-solid fa-chart-bar"></i> Budget vs. Actuals</h3>
                    <canvas id="budget-chart"></canvas>
                </div>

                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4">Expense Breakdown</h2>
                    <div class="h-[300px] flex items-center justify-center">
                        <canvas id="expense-pie-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Column: Add, View & Calculate -->
            <div class="flex flex-col gap-8">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i class="fa-solid fa-plus"></i> Add New Expense</h2>
                    <form id="expense-form" class="space-y-4">
                        <input type="text" id="expense-description" placeholder="Description" required class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg py-3 px-4 focus:outline-none">
                        <input type="number" id="expense-amount" placeholder="Amount" required class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg py-3 px-4 focus:outline-none">
                        <select id="expense-category" required class="w-full bg-gray-900 border-2 border-gray-700 rounded-lg py-3 px-4 focus:outline-none appearance-none"></select>
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg">Add Expense</button>
                    </form>
                </div>

                <div id="tax-calculator-container" class="bg-gray-800 p-6 rounded-2xl shadow-lg"></div>

                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg flex-grow">
                    <h2 class="text-xl font-bold mb-4">Transaction History</h2>
                    <div id="transaction-history" class="space-y-3 pr-2 h-[400px] overflow-y-auto"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, addDoc, collection, onSnapshot, deleteDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug');

        // --- Global State ---
        let userId = null;
        let allExpenses = [];
        let creditCardBills = [];
        let salary = 0;
        let selectedDate = new Date();
        let wisdomIndex = 0;
        let expensePieChartInstance = null;
        let budgetBarChartInstance = null;

        const expenseCategories = ['Food', 'Rent', 'Transport', 'Utilities', 'Entertainment', 'Health', 'Shopping', 'Other'];
        
        // --- DOM Elements ---
        const loader = document.getElementById('loader');
        const mainContent = document.getElementById('main-content');
        const userIdDisplay = document.getElementById('user-id-display');
        
        // --- Financial Wisdom ---
        const financialWisdom = [
            { book: "The Intelligent Investor", author: "Benjamin Graham", quote: "The investor's chief problem—and even his worst enemy—is likely to be himself.", rule: "Invest with a margin of safety. Never overpay for an asset." },
            { book: "The Richest Man in Babylon", author: "George S. Clason", quote: "A part of all you earn is yours to keep.", rule: "Pay yourself first. Aim to save at least 10% of your income before you spend on anything else." },
            { book: "Rich Dad Poor Dad", author: "Robert T. Kiyosaki", quote: "The rich don't work for money. They make money work for them.", rule: "Focus on acquiring income-generating assets, not liabilities that drain your wealth." }
        ];

        // --- Helper Functions ---
        const formatCurrency = (value) => value.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0 });
        
        // --- Main Render Function ---
        function render() {
            if (!userId) return;

            // Filter data for selected month
            const filteredExpenses = allExpenses.filter(expense => {
                const expenseDate = expense.createdAt.toDate();
                return expenseDate.getFullYear() === selectedDate.getFullYear() && expenseDate.getMonth() === selectedDate.getMonth();
            });

            const totalExpenses = filteredExpenses.reduce((sum, exp) => sum + Number(exp.amount), 0);
            const remainingBalance = salary - totalExpenses;
            const totalPendingDues = creditCardBills.filter(bill => !bill.isPaid).reduce((sum, bill) => sum + Number(bill.amount), 0);
            
            // Render Stat Cards
            document.getElementById('salary-card').innerHTML = `
                <div class="flex justify-between items-start"><div><p class="text-sm font-medium text-gray-200 uppercase">Salary</p><p class="text-2xl md:text-3xl font-bold text-white mt-1">${formatCurrency(salary)}</p></div><div class="p-3 bg-black bg-opacity-20 rounded-xl"><i class="fa-solid fa-piggy-bank text-green-400"></i></div></div>
                <button id="edit-salary-btn" class="mt-4 text-xs font-semibold text-white hover:text-gray-300 flex items-center gap-1"><i class="fa-solid fa-edit"></i> Change Salary</button>
            `;
            document.getElementById('expenses-card').innerHTML = `<div><p class="text-sm font-medium text-gray-200 uppercase">Monthly Expenses</p><p class="text-2xl md:text-3xl font-bold text-white mt-1">${formatCurrency(totalExpenses)}</p></div><div class="p-3 bg-black bg-opacity-20 rounded-xl"><i class="fa-solid fa-indian-rupee-sign text-red-400"></i></div>`;
            document.getElementById('dues-card').innerHTML = `<div><p class="text-sm font-medium text-gray-200 uppercase">Pending Dues</p><p class="text-2xl md:text-3xl font-bold text-white mt-1">${formatCurrency(totalPendingDues)}</p></div><div class="p-3 bg-black bg-opacity-20 rounded-xl"><i class="fa-solid fa-credit-card text-yellow-400"></i></div>`;
            document.getElementById('balance-card').innerHTML = `<div><p class="text-sm font-medium text-gray-200 uppercase">Balance</p><p class="text-2xl md:text-3xl font-bold text-white mt-1">${formatCurrency(remainingBalance)}</p></div><div class="p-3 bg-black bg-opacity-20 rounded-xl"><i class="fa-solid fa-piggy-bank text-blue-400"></i></div>`;

            document.getElementById('edit-salary-btn').onclick = () => document.getElementById('salary-modal').classList.add('flex');

            // Render Financial Wisdom
            const wisdom = financialWisdom[wisdomIndex];
            document.getElementById('financial-wisdom-card').innerHTML = `<div class="flex items-start gap-4"><i class="fa-solid fa-book-open text-yellow-400 mt-1 flex-shrink-0 text-2xl"></i><div><h3 class="text-xl font-bold text-white">Financial Wisdom</h3><p class="text-sm text-gray-300 italic mt-2">"${wisdom.quote}"</p><p class="text-xs font-semibold text-gray-400 mt-1">- ${wisdom.author}, ${wisdom.book}</p><div class="mt-4 p-3 bg-gray-900 rounded-lg"><p class="text-gray-200 font-semibold"><i class="fa-solid fa-lightbulb inline mr-2 text-yellow-400"></i>Rule: <span class="font-normal">${wisdom.rule}</span></p></div></div></div>`;

            // Render Transaction History
            const historyContainer = document.getElementById('transaction-history');
            historyContainer.innerHTML = '';
            if(filteredExpenses.length > 0) {
                [...filteredExpenses].sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate()).forEach(expense => {
                    const el = document.createElement('div');
                    el.className = 'flex justify-between items-center bg-gray-900 p-3 rounded-lg';
                    el.innerHTML = `<div><p class="font-semibold">${expense.description}</p><p class="text-sm text-gray-400">${expense.category}</p></div><div class="flex items-center gap-4"><p class="font-bold text-red-400">${formatCurrency(expense.amount)}</p><button data-id="${expense.id}" class="delete-expense-btn text-gray-500 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></div>`;
                    historyContainer.appendChild(el);
                });
            } else {
                historyContainer.innerHTML = `<div class="text-center text-gray-500 pt-16">No transactions for this month.</div>`;
            }
            
            // Render Pie Chart
            renderPieChart(filteredExpenses);

            // Render Bar Chart
            if(salary > 0) {
              document.getElementById('budget-chart-container').style.display = 'block';
              renderBudgetChart(filteredExpenses, salary, remainingBalance);
            } else {
              document.getElementById('budget-chart-container').style.display = 'none';
            }

            // Render Tax Calculator
            if (salary > 0) {
                document.getElementById('tax-calculator-container').style.display = 'block';
                renderTaxCalculator(salary * 12);
            } else {
                document.getElementById('tax-calculator-container').style.display = 'none';
            }
            
            // Render Credit Card Hub
            renderCreditCardHub();
        }

        function renderPieChart(data) {
            const chartData = expenseCategories.map(cat => ({
                label: cat,
                value: data.filter(d => d.category === cat).reduce((sum, item) => sum + item.amount, 0)
            })).filter(d => d.value > 0);

            const ctx = document.getElementById('expense-pie-chart').getContext('2d');
            if(expensePieChartInstance) {
                expensePieChartInstance.destroy();
            }
            if (chartData.length === 0) {
                document.getElementById('expense-pie-chart').innerHTML = '<div class="text-center text-gray-500">No expenses to display.</div>'
                 return;
            }

            expensePieChartInstance = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: chartData.map(d => d.label),
                    datasets: [{
                        data: chartData.map(d => d.value),
                        backgroundColor: ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#AF19FF', '#FF1943', '#19D4FF', '#FF19AF'],
                        borderColor: '#111827',
                        borderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: 'white' }},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${formatCurrency(context.raw)}`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderBudgetChart(expenses, salary, remainingBalance) {
            const actualSpending = { Needs: 0, Wants: 0 };
            expenses.forEach(expense => {
                if (['Rent', 'Utilities', 'Transport', 'Health', 'Food'].includes(expense.category)) { actualSpending.Needs += expense.amount; }
                else if (['Entertainment', 'Shopping'].includes(expense.category)) { actualSpending.Wants += expense.amount; }
            });
            const chartData = [
                { name: 'Needs', Budget: salary * 0.5, Actual: actualSpending.Needs },
                { name: 'Wants', Budget: salary * 0.3, Actual: actualSpending.Wants },
                { name: 'Savings', Budget: salary * 0.2, Actual: Math.max(0, remainingBalance) }
            ];

            const ctx = document.getElementById('budget-chart').getContext('2d');
            if (budgetBarChartInstance) {
                budgetBarChartInstance.destroy();
            }
            budgetBarChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.map(d => d.name),
                    datasets: [
                        { label: 'Budget', data: chartData.map(d => d.Budget), backgroundColor: '#4299E1' },
                        { label: 'Actual', data: chartData.map(d => d.Actual), backgroundColor: '#48BB78' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'white', callback: (value) => `₹${value/1000}k` }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    },
                    plugins: {
                        legend: { labels: { color: 'white' }},
                        tooltip: { callbacks: { label: (context) => `${context.dataset.label}: ${formatCurrency(context.raw)}` }}
                    }
                }
            });
        }

        function renderCreditCardHub() {
            const container = document.getElementById('pending-bills-container');
            container.innerHTML = '';
            const pendingBills = creditCardBills.filter(b => !b.isPaid).sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate));

            if(pendingBills.length > 0) {
                pendingBills.forEach(bill => {
                    const dueDate = new Date(bill.dueDate + 'T00:00:00');
                    const today = new Date(); today.setHours(0,0,0,0);
                    const daysDiff = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
                    let dateColor = 'text-gray-400'; let borderColor = 'border-gray-700';
                    if (daysDiff < 0) { dateColor = 'text-red-400'; borderColor = 'border-red-500'; }
                    else if (daysDiff <= 5) { dateColor = 'text-yellow-400'; borderColor = 'border-yellow-500'; }

                    const el = document.createElement('div');
                    el.className = `bg-gray-900 p-4 rounded-lg border-l-4 ${borderColor} flex flex-col justify-between`;
                    el.innerHTML = `
                        <div>
                            <div class="flex justify-between items-start">
                                <p class="font-semibold text-white">${bill.cardName}</p>
                                <button data-id="${bill.id}" class="delete-bill-btn text-gray-600 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                            </div>
                            <p class="text-2xl font-bold text-red-400 my-2">${formatCurrency(Number(bill.amount))}</p>
                            <p class="text-sm font-medium ${dateColor} flex items-center gap-1.5"><i class="fa-solid fa-calendar"></i> Due: ${dueDate.toLocaleDateString()}</p>
                        </div>
                        <button data-id="${bill.id}" class="pay-bill-btn mt-4 w-full bg-green-600 hover:bg-green-500 text-white font-bold py-2 rounded-lg flex items-center justify-center gap-2 transition-colors"><i class="fa-solid fa-check-circle"></i> Mark as Paid</button>
                    `;
                    container.appendChild(el);
                });
            } else {
                container.innerHTML = `<div class="text-center text-gray-500 py-10 col-span-full">No pending credit card bills. Great job!</div>`;
            }
        }
        
        // --- Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `UID: ${userId}`;
                    setupListeners();
                    loader.style.display = 'none';
                    mainContent.style.display = 'block';
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auth Error:", error);
                    }
                }
            });
            
            // Populate category dropdown
            const categorySelect = document.getElementById('expense-category');
            expenseCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categorySelect.appendChild(option);
            });
        });
        
        // --- Data Listeners ---
        function setupListeners() {
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/expenses`), (snap) => {
                allExpenses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
            onSnapshot(doc(db, `artifacts/${appId}/users/${userId}/profile/salary`), (doc) => {
                salary = doc.exists() ? doc.data().monthlySalary : 0;
                render();
            });
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/creditCardBills`), (snap) => {
                creditCardBills = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render();
            });
        }
        
        // --- UI Interactions ---
        // Modals
        document.getElementById('cancel-salary').onclick = () => document.getElementById('salary-modal').classList.remove('flex');
        document.getElementById('cancel-bill').onclick = () => document.getElementById('bill-modal').classList.remove('flex');
        document.getElementById('add-bill-btn').onclick = () => document.getElementById('bill-modal').classList.add('flex');

        // Salary
        document.getElementById('save-salary').onclick = async () => {
            const newSalary = parseFloat(document.getElementById('new-salary-input').value);
            if (userId && newSalary > 0) {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/profile/salary`), { monthlySalary: newSalary });
                document.getElementById('salary-modal').classList.remove('flex');
            }
        };

        // Month Navigator
        document.getElementById('month-year-display').textContent = selectedDate.toLocaleString('default', { month: 'long', year: 'numeric' });
        document.getElementById('prev-month').onclick = () => {
            selectedDate.setMonth(selectedDate.getMonth() - 1);
            document.getElementById('month-year-display').textContent = selectedDate.toLocaleString('default', { month: 'long', year: 'numeric' });
            render();
        };
        document.getElementById('next-month').onclick = () => {
            const nextMonth = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 1);
            if(nextMonth <= new Date()) {
                selectedDate.setMonth(selectedDate.getMonth() + 1);
                document.getElementById('month-year-display').textContent = selectedDate.toLocaleString('default', { month: 'long', year: 'numeric' });
                render();
            }
        };

        // Forms
        document.getElementById('expense-form').onsubmit = async (e) => {
            e.preventDefault();
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const category = document.getElementById('expense-category').value;
            if (description && amount > 0 && category && userId) {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/expenses`), { description, amount, category, createdAt: new Date() });
                e.target.reset();
            }
        };
        document.getElementById('bill-form').onsubmit = async (e) => {
            e.preventDefault();
            const cardName = document.getElementById('bill-card-name').value;
            const amount = parseFloat(document.getElementById('bill-amount').value);
            const dueDate = document.getElementById('bill-due-date').value;
            if(cardName && amount > 0 && dueDate && userId) {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/creditCardBills`), { cardName, amount, dueDate, isPaid: false });
                document.getElementById('bill-modal').classList.remove('flex');
                e.target.reset();
            }
        };

        // Event delegation for delete/pay buttons
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const id = target.dataset.id;
            if(!id || !userId) return;

            if (target.classList.contains('delete-expense-btn')) {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/expenses/${id}`));
            }
            if (target.classList.contains('delete-bill-btn')) {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/creditCardBills/${id}`));
            }
            if (target.classList.contains('pay-bill-btn')) {
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/creditCardBills/${id}`), { isPaid: true });
            }
        });

    </script>
</body>
</html>
